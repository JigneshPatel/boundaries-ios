# Geofences Sample app
--

The Geofences sample app that introduces you to the geofence features of the ContextHub iOS SDK and developer portal.

## Purpose
This sample application will show you how to create, retrieve, update, and delete (CRUD) geofences as well as respond to geofence in and out events in ContextHub.

## ContextHub

In this sample application, we use ContextHub to CRUD geofences on the server then respond to geofence in and out events by displaying a notification. ContextHub takes care of setting up and monitoring geofences automatically after creation and synchronization

## Getting Started

1. Get started by either forking or cloning the Geofence repo. Visit [GitHub Help](https://help.github.com/articles/fork-a-repo) if you need help.
2. Go to [ContextHub](http://app.contexthub.com) and create a new Geofence application.
3. Find the app id associated with the application you just created. Its format looks something like this: `13e7e6b4-9f33-4e97-b11c-79ed1470fc1d`.
4. Open up your Xcode project and put the app id into the `[ContextHub registerWithAppId:]` method call.
5. Build and run the project in the simulator.

## Xcode Console

1. This sample demo will log events into the debug console to get an idea of the JSON structure posted to ContextHub. Use shortcut `Shift-âŒ˜-Y` if your console is not already visible.
2. You should see the message "CCH: Device has successfully registered your application ID with ContextHub".
3. Within the application delegate are 4 methods defined by the `CCHSensorPipelineDataSource` and `CCHSensorPipelineDelegate` which allow you hook into the pipeline of events generated by the device sensors. You can get notified when an event will post and has been posted, as well as control if an event should be posted and add extra payload data to an event. These 4 methods allow a lot of flexibility in controlling what events get sent to the server.
4. Check out the ContextHub [documentation](http://docs.contexthub.com) for more information about the event service.

## ContextHub.com

1. The real power of ContextHub comes from collecting and reacting to events posted from devices onto the server. Go to the [developer portal](https://app.contexthub.com) and click on your  Geofence app to access its data.
2. Click on the "Geofences" tab.  You should see the geofence that you just created in the simulator.  From here you can create, update, and delete geofences.
3. Next click on the Contexts link which will take you to the "Contexts" page. Contexts let you change how the server will respond to events triggered by devices. Let's go ahead and create a new context.

## Creating a New Context

1. In the "Contexts" tab, click the "New Context" button to start making a new rule.
2. Enter a name for this context which will be easy for you to remember. For now, name it "Geofence In".
3. Select the `"geofence_in"` event type. Now any event of type `"geofence_in"` will trigger this rule. You can have multiple rules with the same event type, which is why the name of events should be descriptive of the rule.
4. The Context Rule text box is where you can write a rule telling ContextHub what actions to take in response to an event triggered with the specific event type. This code is Javascript, and you have access to some context objects: event, push, vault, http, and console. For now, leave the Code box blank and then click save.

## Create a Geofence

1. Back in the simulator you'll see a map view that is centered at the current location.  Lets set your location to one of the major cities XCode provides (click on the compass arrow in the debug controls area of XCode in the bottom). Zoom in as closely as possible to street level where the location circle appears on the map.
2. Tap the "+" located at the top right of the application to create a new geofence.  Give it a name and tap okay.  This will create a geofence on the ContextHub server.

## Build and Run

1. Back in Xcode, stop and restart the simulator.
2. Simulate a location change in the device to one of the major cities Xcode provides.
3. Change the simulated location in XCode back to where you previously were and you should see a `"geofence_in"` event triggered and printed to the console. If you are having issues with events not being generated, see the note at the bottom for help.
4. In the ContextHub [developer portal](http://app.contexthub.com), you should be able to see events generated by your device appear under "Latest events", no code needed!

## Code

In this sample, most of the important code that deals with CRUDing geofences occurs in GFGeofenceStore.m. Each method goes though a single operation you'll need to use `CCHGeofenceService`. After each CUD operation, a synchronization call is made so that `CCHSensorPipeline` is up to date with the latest data. This method becomes unnecessary if you have properly implemented push as background notifications will take care of synchronization for you.

In addition, `GFMapViewController` responds to any events created from the sensor pipeline through the `CCHSensorPipelineDidPostEvent` notification. At that point, you'll be able to filter whether the event was a geofence event which you were interested in and respond accordingly. There are several pre-defined keys that let you access information stored in an event, such as event name, state, type, etc..

